# mysterio_backend

## Goal

AI がマーダーミステリーのシナリオを生成
少人数(5 人程度)が対面で 1 ～ 2 時間遊べる体験を、準備コストほぼゼロで提供する。

### MVP

- シナリオ生成からプレイ終了まで破綻なく完走可能
  - シナリオの分岐はなし
- 進行役なしで遊ぶことができる
- プレイヤーごとの情報秘匿が成立している

## ユーザーの行動

- 代表者が Web アプリで「新規セッション作成」
- AI がシナリオを生成
- 各プレイヤーに役割が割り当てられる
  - QR コード読み取りや、リンクの共有といった方法
- プレイヤーは自分の端末で情報を確認
- フェーズに従って議論・推理・投票
- 結末が開示され、ゲーム終了

## 機能要件

### A. セッションの管理

- セッションの作成
  - プレイヤー人数: 最大 5 人
  - 難易度: 3 段階(easy, medium, hard)
  - プレイ時間目安: 30 分~120 分
- セッション状態取得
  - 現在フェーズ
  - 終了状態

### B. シナリオ生成

- AI によるシナリオ完全生成
  - 物語の背景、設定
  - キャラクター: プレイヤーの人数分
  - キャラクターの役割
  - 真相
  - フェーズ構成: 2 時間のシナリオなら 5 個程度

### C. プレイヤー情報配信

- プレイヤーごとに情報を取得

  - 自分だけが知ることができる情報
    - 自分の役割
    - 自分だけが知る情報
  - 共通して知ることができる情報
    - フェーズの説明
    - 公開テキスト

- プレイヤー識別は Header（例: X-Player-Id）

### D. フェーズ進行

- 現在のフェーズ取得
- 次のフェーズへ移行

### E. アクション

- 投票(最終フェーズのみ)

## API 定義

### 1. セッション作成

```bash
POST /sessions
```

#### 目的

新しいマーダーミステリーのシナリオを一回分生成

#### リクエスト

- playerCount: number
- difficulty: string
  - difficulty によって時間目安を変える, hard なら 2 時間など

#### レスポンス

- sessionId
- ownerPlayerId: セッション作成者の ID。ゲーム進行の権限を持たせる
- playerIds: 配布用
- 初期フェーズ情報(共通)

#### メモ

- ここでシナリオ生成を行う
- シナリオ生成 -> プレイヤー情報生成 -> リンクなど共有できる形でプレイヤー情報を生成

### 2. 現在のフェーズ取得

```bash
GET /sessions/{sessionId}/phase
```

header: X-Player-Id

#### 目的

- 今のフェーズの説明・公開情報・個人情報を取得

#### レスポンス

- phaseType
- publicText
- privateText: 役割に依存
- availableActions

### 3. フェーズ進行（進行役による操作）

```bash
POST /sessions/{sessionId}/phase/advance
```

header: X-Player-Id

#### 目的

- 次のフェーズに進む

#### メモ

X-Player-Id の値が、session で保持している ownerPlayerId と一致しなければ 403 を返す

### 4. 投票

```bash
POST /sessions/{sessionId}/vote
```

header: X-Player-Id

#### リクエスト

- targetPlayerId

#### 目的

- 最終フェーズでの投票

#### メモ

- 最終フェーズのみ有効
- 一人一票とする。上書き不可

### 5. 結果取得

```bash
GET /sessions/{sessionId}/result
```

#### 目的

- 真相、勝敗、投票結果を開示

#### レスポンス

- truth
- winnerPlayerId
- votingResult

#### メモ

最終フェーズ終了後のみ
